{{define "generation"}}<!DOCTYPE html>
<html lang="en">
<head>
  {{template "gtag" .}}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Great Stories — Generation</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    section { margin-bottom: 2rem; padding: 1.25rem; border: 1px solid #e0e0e0; border-radius: 8px; }
    section h2 { font-size: 1.1rem; margin-top: 0; margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input, textarea, select { width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; border: 1px solid #ccc; border-radius: 4px; }
    input[type="checkbox"] { width: auto; margin-bottom: 0; }
    label.checkbox-row { display: inline-block; margin-bottom: 0.75rem; }
    textarea { min-height: 80px; resize: vertical; }
    button { padding: 0.5rem 1rem; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #555; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .result { margin-top: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 4px; font-size: 0.9rem; white-space: pre-wrap; word-break: break-all; }
    .error { background: #fee; color: #c00; }
    .poll-status { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; }
    .get-job-loading { display: none; margin-bottom: 0.75rem; }
    .get-job-loading.visible { display: block; }
    .loading-dots::after { content: ''; animation: loading-dots 1.5s steps(4, end) infinite; }
    @keyframes loading-dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
    .get-job-view-link { margin-left: 0.25rem; }
    .nav-link { margin-right: 1rem; }
    .api-docs { margin-bottom: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px; }
    .api-docs summary { padding: 0.75rem 1rem; cursor: pointer; font-weight: 500; list-style: none; }
    .api-docs summary::-webkit-details-marker { display: none; }
    .api-docs summary::before { content: '▶'; display: inline-block; margin-right: 0.5rem; font-size: 0.7em; transition: transform 0.2s; }
    .api-docs[open] summary::before { transform: rotate(90deg); }
    .api-docs-inner { padding: 0 1rem 1rem; font-size: 0.9rem; color: #444; }
    .api-docs-inner h4 { margin: 1rem 0 0.35rem; font-size: 0.95rem; }
    .api-docs-inner h4:first-child { margin-top: 0; }
    .api-docs-inner pre { background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto; font-size: 0.85em; }
    .api-docs-inner p { margin: 0.25rem 0 0; }
  </style>
</head>
<body>
  <h1>Great Stories — Generation</h1>
  <p><a href="/" class="nav-link">Tasks</a><a href="/generation" class="nav-link">Generation</a>{{.NavAgentsLink}}</p>
  <p>Send a test job request and check job status.</p>

  <details class="api-docs">
    <summary>API description</summary>
    <div class="api-docs-inner">
      <h4>POST /v1/jobs</h4>
      <p>Create a new enrichment job. Use <code>Authorization: Bearer &lt;api_key&gt;</code>.</p>
      <p><strong>Request:</strong> Provide <code>text</code> and/or <code>file_ids</code> (upload files first via POST /v1/files).</p>
      <pre>{
  "text": "string (optional if file_ids provided)",
  "file_ids": ["uuid", "..."],
  "type": "educational | financial | fictional",
  "segments_count": "integer (1–max from config)",
  "audio_type": "free_speech | podcast",
  "fact_check_needed": "boolean (optional, default false)",
  "webhook": { "url": "string (optional)", "secret": "string (optional)" }
}</pre>
      <p><strong>POST /v1/files</strong> — Upload a file (multipart form, field <code>file</code>). Returns <code>file_id</code>. Use these IDs in <code>file_ids</code> when creating a job.</p>
      <p><strong>Response (202):</strong> <code>{ "job_id", "status": "queued", "created_at" }</code></p>
      <h4>GET /v1/jobs/{job_id}</h4>
      <p>Get job status, segments, and assets (with download URLs).</p>
      <h4>GET /v1/jobs</h4>
      <p>List your jobs (with pagination).</p>
      <h4>GET /v1/assets/{asset_id} / GET /v1/assets/{asset_id}/content</h4>
      <p>Asset metadata and pass-through content.</p>
    </div>
  </details>

  <section>
    <h2>API key</h2>
    <label for="api-key">Use this key for both forms below</label>
    <input type="password" id="api-key" name="api_key" placeholder="API key" autocomplete="off" data-1p-ignore>
  </section>

  <section>
    <h2>Send request</h2>
    <form id="test-request">
      <label for="text">Text (optional if you add files)</label>
      <textarea id="text" name="text" placeholder="Short story or paragraph to enrich..." maxlength="50000"></textarea>
      <p id="text-remaining" style="font-size:0.85rem;color:#666;margin:-0.5rem 0 0.75rem 0;">50000 characters remaining</p>
      <label for="files">Files (optional). PDF or images. Uploaded when you send the request.</label>
      <input type="file" id="files" name="files" multiple accept=".pdf,image/jpeg,image/png,image/gif,image/webp,application/pdf">
      <p id="files-summary" style="font-size:0.85rem;color:#666;margin:-0.5rem 0 0.75rem 0;">No files selected</p>
      <p style="font-size:0.8rem;color:#888;margin:-0.25rem 0 0.75rem 0;">Disclaimer: Files containing copyrighted content (e.g. book pages, articles, comics) may fail to process due to content policy.</p>
      <label for="type">Type</label>
      <select id="type" name="type">
        <option value="educational">Educational</option>
        <option value="financial">Financial</option>
        <option value="fictional">Fictional</option>
      </select>
      <label for="segments_count">Segments count</label>
      <input type="number" id="segments_count" name="segments_count" value="2" min="1" max="{{.MaxSegmentsCount}}">
      <label for="audio_type">Audio type</label>
      <select id="audio_type" name="audio_type">
        <option value="free_speech">Free speech</option>
        <option value="podcast">Podcast</option>
      </select>
      <label class="checkbox-row"><input type="checkbox" id="fact_check_needed" name="fact_check_needed"> Fact-check segments</label>
      <br><button type="submit" id="send-test-btn">Send request</button>
    </form>
    <div id="test-request-result" class="result" style="display:none;"></div>
  </section>

  <section>
    <h2>Get job data</h2>
    <div id="get-job-loading" class="get-job-loading">
      <span class="loading-dots">Processing</span>
      <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">Processing may take up to 10 minutes, depending on the text length.</p>
    </div>
    <p id="get-job-poll-status" class="poll-status" style="display:none;"></p>
    <span id="get-job-view-wrap" style="display:none;"><a id="get-job-view-link" href="#" class="get-job-view-link">View</a></span>
    <form id="get-job">
      <label for="job-id">Job ID</label>
      <input type="text" id="job-id" name="job_id" placeholder="e.g. 550e8400-e29b-41d4-a716-446655440000" required>
      <button type="submit">Get job</button>
    </form>
    <p id="get-job-copy-wrap" style="display:none; margin-bottom:0.5rem;">
      <button type="button" id="get-job-copy-btn">Copy response</button>
      <span id="get-job-copy-feedback" style="margin-left:0.5rem; font-size:0.9rem; color:#666;"></span>
    </p>
    <div id="get-job-result" class="result" style="display:none;"></div>
  </section>

  <script>
    var MAX_TEXT_LENGTH = 50000;
    var MAX_SEGMENTS_COUNT = {{.MaxSegmentsCount}};
    var textEl = document.getElementById('text');
    var remainingEl = document.getElementById('text-remaining');
    function updateRemaining() {
      var len = textEl.value.length;
      var rem = MAX_TEXT_LENGTH - len;
      remainingEl.textContent = rem + ' characters remaining';
      if (rem < 0) remainingEl.style.color = '#c00';
      else remainingEl.style.color = '#666';
    }
    textEl.addEventListener('input', updateRemaining);
    textEl.addEventListener('paste', function() { setTimeout(updateRemaining, 0); });

    var filesInput = document.getElementById('files');
    var filesSummary = document.getElementById('files-summary');
    function updateFilesSummary() {
      var n = filesInput.files.length;
      filesSummary.textContent = n === 0 ? 'No files selected' : n + ' file(s) selected';
    }
    filesInput.addEventListener('change', updateFilesSummary);

    document.getElementById('test-request').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultEl = document.getElementById('test-request-result');
      const sendBtn = document.getElementById('send-test-btn');
      resultEl.style.display = 'block';
      resultEl.classList.remove('error');
      const text = document.getElementById('text').value.trim();
      const fileList = filesInput.files;
      const hasFiles = fileList && fileList.length > 0;
      if (!text && !hasFiles) {
        resultEl.textContent = 'Please enter text and/or select at least one file.';
        resultEl.classList.add('error');
        return;
      }
      if (text.length > MAX_TEXT_LENGTH) {
        resultEl.textContent = 'Text is too long. Maximum ' + MAX_TEXT_LENGTH + ' characters.';
        resultEl.classList.add('error');
        return;
      }
      const apiKey = document.getElementById('api-key').value.trim();
      if (!apiKey) {
        resultEl.textContent = 'Please enter an API key.';
        resultEl.classList.add('error');
        return;
      }
      const segmentsCount = parseInt(document.getElementById('segments_count').value, 10) || 2;
      if (segmentsCount > MAX_SEGMENTS_COUNT || segmentsCount < 1) {
        resultEl.textContent = 'Segments count must be between 1 and ' + MAX_SEGMENTS_COUNT + '.';
        resultEl.classList.add('error');
        return;
      }

      var fileIds = [];
      if (hasFiles) {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Uploading 0/' + fileList.length + '...';
        resultEl.textContent = 'Uploading files...';
        try {
          for (var i = 0; i < fileList.length; i++) {
            sendBtn.textContent = 'Uploading ' + (i + 1) + '/' + fileList.length + '...';
            var fd = new FormData();
            fd.append('file', fileList[i]);
            var uploadRes = await fetch('/v1/files', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + apiKey },
              body: fd
            });
            var uploadData = await uploadRes.json();
            if (!uploadRes.ok) {
              resultEl.textContent = 'Upload failed: ' + (uploadData.error || uploadRes.statusText);
              resultEl.classList.add('error');
              sendBtn.disabled = false;
              sendBtn.textContent = 'Send request';
              return;
            }
            fileIds.push(uploadData.file_id);
          }
        } catch (err) {
          resultEl.textContent = 'Upload error: ' + err.message;
          resultEl.classList.add('error');
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send request';
          return;
        }
        sendBtn.textContent = 'Creating job...';
      }

      var payload = {
        type: document.getElementById('type').value,
        segments_count: segmentsCount,
        audio_type: document.getElementById('audio_type').value,
        fact_check_needed: document.getElementById('fact_check_needed').checked
      };
      if (text) payload.text = text;
      if (fileIds.length > 0) payload.file_ids = fileIds;

      try {
        const res = await fetch('/v1/jobs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          resultEl.textContent = 'Error: ' + (data.error || res.statusText);
          resultEl.classList.add('error');
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send request';
          return;
        }
        resultEl.textContent = 'Job created.\njob_id: ' + data.job_id + '\nstatus: ' + data.status;
        document.getElementById('job-id').value = data.job_id || '';
      } catch (err) {
        resultEl.textContent = 'Error: ' + err.message;
        resultEl.classList.add('error');
      }
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send request';
    });

    var getJobPollTimer = null;
    function stopGetJobPoll() {
      if (getJobPollTimer) {
        clearInterval(getJobPollTimer);
        getJobPollTimer = null;
      }
      document.getElementById('get-job-poll-status').style.display = 'none';
      document.getElementById('get-job-loading').classList.remove('visible');
    }
    function fetchAndShowJob(apiKey, jobId, resultEl, pollStatusEl, isPoll) {
      return fetch('/v1/jobs/' + encodeURIComponent(jobId), {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + apiKey }
      }).then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
        .then(function(_ref) {
          var res = _ref.res, data = _ref.data;
          if (!res.ok) {
            resultEl.textContent = 'Error: ' + (data.error || res.statusText);
            resultEl.classList.add('error');
            if (isPoll) stopGetJobPoll();
            return null;
          }
          resultEl.classList.remove('error');
          resultEl.textContent = JSON.stringify(data, null, 2);
          if (pollStatusEl && data.job) {
            pollStatusEl.style.display = 'block';
            pollStatusEl.textContent = 'Polling every 5s. Status: ' + (data.job.status || '');
          }
          return data.job ? data.job.status : null;
        }).catch(function(err) {
          resultEl.textContent = 'Error: ' + err.message;
          resultEl.classList.add('error');
          if (isPoll) stopGetJobPoll();
          return null;
        });
    }
    document.getElementById('get-job').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultEl = document.getElementById('get-job-result');
      const copyWrap = document.getElementById('get-job-copy-wrap');
      const pollStatusEl = document.getElementById('get-job-poll-status');
      const loadingEl = document.getElementById('get-job-loading');
      const viewWrap = document.getElementById('get-job-view-wrap');
      const viewLink = document.getElementById('get-job-view-link');
      resultEl.style.display = 'block';
      copyWrap.style.display = 'block';
      resultEl.classList.remove('error');
      const apiKey = document.getElementById('api-key').value.trim();
      const jobId = document.getElementById('job-id').value.trim();
      if (!apiKey) {
        resultEl.textContent = 'Please enter an API key above.';
        resultEl.classList.add('error');
        return;
      }
      if (!jobId) {
        resultEl.textContent = 'Please enter a job ID.';
        resultEl.classList.add('error');
        return;
      }
      stopGetJobPoll();
      viewWrap.style.display = 'none';
      loadingEl.classList.add('visible');
      try {
        const status = await fetchAndShowJob(apiKey, jobId, resultEl, pollStatusEl, false);
        viewLink.setAttribute('href', '/view/' + encodeURIComponent(jobId));
        viewWrap.style.display = 'inline';
        if (status !== 'succeeded' && status !== 'failed' && status !== 'canceled') {
          getJobPollTimer = setInterval(function() {
            fetchAndShowJob(apiKey, jobId, resultEl, pollStatusEl, true).then(function(s) {
              if (s === 'succeeded' || s === 'failed' || s === 'canceled') stopGetJobPoll();
            });
          }, 5000);
        } else {
          loadingEl.classList.remove('visible');
        }
      } catch (err) {
        resultEl.textContent = 'Error: ' + err.message;
        resultEl.classList.add('error');
        loadingEl.classList.remove('visible');
      }
    });

    document.getElementById('get-job-copy-btn').addEventListener('click', function() {
      const resultEl = document.getElementById('get-job-result');
      const feedback = document.getElementById('get-job-copy-feedback');
      var text = resultEl.textContent || '';
      if (!text) {
        feedback.textContent = 'Nothing to copy.';
        setTimeout(function() { feedback.textContent = ''; }, 2000);
        return;
      }
      navigator.clipboard.writeText(text).then(function() {
        feedback.textContent = 'Copied!';
        setTimeout(function() { feedback.textContent = ''; }, 2000);
      }).catch(function() {
        feedback.textContent = 'Copy failed.';
        setTimeout(function() { feedback.textContent = ''; }, 2000);
      });
    });
  </script>
</body>
</html>
{{end}}
